<!doctype html><html lang=en-us><head><title>Metal3 | Underkube</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Tips, tricks and all things k8s/OpenShift/containers/etc"><meta name=generator content="Hugo 0.128.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><meta name=keywords content="kubernetes,metal3,openshift"><link rel=canonical href=https://www.underkube.com/pr-preview/pr-46/metal3/><script>!function(e,t){var n,s,o,i;t.__SV||(window.posthog=t,t._i=[],t.init=function(a,r,c){function d(e,t){var n=t.split(".");2==n.length&&(e=e[n[0]],t=n[1]),e[t]=function(){e.push([t].concat(Array.prototype.slice.call(arguments,0)))}}(n=e.createElement("script")).type="text/javascript",n.crossOrigin="anonymous",n.async=!0,n.src=r.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(i=e.getElementsByTagName("script")[0]).parentNode.insertBefore(n,i);var l=t;for(void 0!==c?l=t[c]=[]:c="posthog",l.people=l.people||[],l.toString=function(e){var t="posthog";return"posthog"!==c&&(t+="."+c),e||(t+=" (stub)"),t},l.people.toString=function(){return l.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug getPageViewId".split(" "),s=0;s<o.length;s++)d(l,o[s]);t._i.push([a,r,c])},t.__SV=1)}(document,window.posthog||[]),posthog.init("phc_uEqii0McatXuj5LJOegCHPbPJOk3px5r9cF2qGV0AiG",{api_host:"https://eu.i.posthog.com",person_profiles:"identified_only"})</script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>All Posts</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a href=https://github.com/e-minguez/underkube>GitHub</a>
<a class=button href>Subscribe</a></nav><main class=main><section id=single><h1 class=title>Metal3</h1><div class=tip><time datetime="2019-06-25 17:19:14 +0200 +0200">Jun 25, 2019</time>
<span class=split>¬∑
</span><span>1625 words
</span><span class=split>¬∑
</span><span>8 minute read</span></div><div class=content><p>In this blog post, I&rsquo;m going to try to explain in my own words a high level
overview of what <a href=https://metal3.io target=_blank rel=noopener>Metal3</a> is, the motivation behind it and some concepts related
to a &lsquo;baremetal operator&rsquo;.</p><p>Let&rsquo;s have some definitions!</p><h1 id=custom-resource-definition>Custom Resource Definition <a href=#custom-resource-definition class=anchor>üîó</a></h1><p>The k8s API provides some out-of-the-box objects such as pods, services, etc.
There are a few methods of <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/ target=_blank rel=noopener>extending the k8s API</a> (such as API extensions)
but since a few releases back, the k8s API can be extended easily with <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/ target=_blank rel=noopener>custom resources definitions</a> (CRDs).
Basically this means you can virtually create any type of object <strong>definition</strong> in k8s
(actually only user with cluster-admin capabilities) with a yaml such as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apiextensions.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>CustomResourceDefinition</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>crontabs.stable.example.com</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>group</span>: <span style=color:#ae81ff>stable.example.com</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># list of versions supported by this CustomResourceDefinition</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>versions</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Each version can be enabled/disabled by Served flag.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>served</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># One and only one version must be marked as the storage version.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># either Namespaced or Cluster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scope</span>: <span style=color:#ae81ff>Namespaced</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>names</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>plural</span>: <span style=color:#ae81ff>crontabs</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># singular name to be used as an alias on the CLI and for display</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>singular</span>: <span style=color:#ae81ff>crontab</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># kind is normally the CamelCased singular type. Your resource manifests use this.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>CronTab</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># shortNames allow shorter string to match your resource on the CLI</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>shortNames</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ct</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>preserveUnknownFields</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>validation</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>openAPIV3Schema</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cronSpec</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>replicas</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
</span></span></code></pre></div><p>And after <code>kubectl apply -f</code> you can <code>kubectl get crontabs</code>.</p><p>There are tons of information with regards to CRDs, like the <a href=https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/ target=_blank rel=noopener>k8s official documentation</a>.</p><p>The CRD by himself is not useful &lsquo;per se&rsquo; as nobody will take care of it (that&rsquo;s why I said <strong>definition</strong>). It
requires a <code>controller</code> to watch for those new objects and react to different
events affecting the object.</p><h1 id=controller>Controller <a href=#controller class=anchor>üîó</a></h1><p>A controller is basically a loop that watches the current status of an object
and if it is different from the desired status, it fix it (reconciliation).
This is why k8s is &lsquo;declarative&rsquo;, you specify the object desired status instead
&lsquo;how to do it&rsquo; (imperative).</p><p>Again, there are tons of documentation (and <a href=https://github.com/kubernetes/sample-controller target=_blank rel=noopener>examples</a>) around the <a href=https://engineering.bitnami.com/articles/a-deep-dive-into-kubernetes-controllers.html target=_blank rel=noopener>controller</a> pattern which is
basically the k8s roots, so I&rsquo;ll let your google-foo take care of it :)</p><h1 id=operator>Operator <a href=#operator class=anchor>üîó</a></h1><p>An Operator (in k8s slang) is an application running in your k8s
cluster that deploys, manages and maintain (so, operates) a k8s application.</p><p>This k8s application (the one that the operator manages), can be as simple as a &lsquo;hello world&rsquo; application
containerized and deployed in your k8s cluster or it can be a much more complex
thing, such a database cluster.</p><p>The &lsquo;operator&rsquo; is like an &rsquo;expert sysadmin&rsquo; containerized that takes care of
your application.</p><p>Bear in mind that the &rsquo;expert&rsquo; tag (meaning the automation behind the operator)
depends on the operator implementation&mldr; so there can be basic operators that
only deploy your application or complex operators that handle day 2 operations
such as upgrades, fail overs, backup/restore, etc.</p><p>See the <a href=https://coreos.com/operators/ target=_blank rel=noopener>CoreOS operator definition</a> for more information.</p><h1 id=cloud-controller-manager>Cloud Controller Manager <a href=#cloud-controller-manager class=anchor>üîó</a></h1><p>k8s code is smart enough to be able to leverage
the underlying infrastructure where the cluster is running, such as being able
of creating &lsquo;LoadBalancer&rsquo; services, understanding the cluster topology based on the cloud provider AZs where the nodes are running (for scheduling reasons), etc.</p><p>This task of &rsquo;talking to the cloud provider&rsquo; is performed by the Cloud Controller Manager (CCM) and for more
information you can take a look at the official k8s documentation with
regards the <a href=https://kubernetes.io/docs/concepts/architecture/cloud-controller/ target=_blank rel=noopener>architecture</a> and the <a href=https://kubernetes.io/docs/tasks/administer-cluster/running-cloud-controller/#cloud-controller-manager target=_blank rel=noopener>administration</a> (also, if you are brave enough, you can create your own <a href=https://kubernetes.io/docs/tasks/administer-cluster/developing-cloud-controller-manager/ target=_blank rel=noopener>cloud controller manager</a> )</p><h1 id=cluster-api>Cluster API <a href=#cluster-api class=anchor>üîó</a></h1><p>The Cluster API implementation is a WIP &lsquo;framework&rsquo; that allows a k8s cluster to manage itself, including the ability of creating new clusters, adding more nodes, etc. in a &lsquo;k8s way&rsquo; (declarative, controllers, CRDs, etc.), so there are objects such as <code>Cluster</code> that can be expressed as k8s objects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;cluster.k8s.io/v1alpha1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mycluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterNetwork</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>cidrBlocks</span>: [<span style=color:#e6db74>&#34;10.96.0.0/12&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>pods</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>cidrBlocks</span>: [<span style=color:#e6db74>&#34;192.168.0.0/16&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>serviceDomain</span>: <span style=color:#e6db74>&#34;cluster.local&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>providerSpec</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>but also:</p><ul><li><a href=https://github.com/kubernetes-sigs/cluster-api/blob/master/pkg/apis/cluster/v1alpha1/machine_types.go target=_blank rel=noopener><code>Machine</code> type objects</a></li><li><a href=https://github.com/kubernetes-sigs/cluster-api/blob/master/pkg/apis/cluster/v1alpha1/machineset_types.go target=_blank rel=noopener><code>MachineSet</code> type objects</a></li><li><a href=https://github.com/kubernetes-sigs/cluster-api/blob/master/pkg/apis/cluster/v1alpha1/machinedeployment_types.go target=_blank rel=noopener><code>MachineDeployment</code> type objects</a></li><li><a href=https://github.com/kubernetes-sigs/cluster-api/tree/master/pkg/apis/cluster/v1alpha1 target=_blank rel=noopener>etc</a></li></ul><p>There are some
provider implementations in the wild such as the AWS, Azure, GCP, OpenStack,
vSphere, etc. ones and the Cluster API project is driven by the <a href=https://github.com/kubernetes/community/tree/master/sig-cluster-lifecycle target=_blank rel=noopener>SIG Cluster Lifecycle</a>.</p><p>Please review the official <a href=https://github.com/kubernetes-sigs/cluster-api target=_blank rel=noopener>Cluster API</a> repository for more information.</p><h2 id=actuator>Actuator <a href=#actuator class=anchor>üîó</a></h2><p>The <code>actuator</code> is a Cluster API interface that reacts to changes to <code>Machine</code>
objects reconciliating the <code>Machine</code> status.</p><p>The actuator code is tightly coupled with the provider (that&rsquo;s why it is an
interface) such as the <a href=https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/master/pkg/cloud/aws/actuators/cluster/actuator.go target=_blank rel=noopener>AWS one</a>.</p><h1 id=machineset-vs-machine>MachineSet vs Machine <a href=#machineset-vs-machine class=anchor>üîó</a></h1><p>To simplify, let&rsquo;s say that <code>MachineSets</code> are to <code>Machines</code> what <code>ReplicaSets</code> are
to <code>Pods</code>. So you can scale the <code>Machines</code> in your cluster just by changing
the number of replicas of a <code>MachineSet</code>.</p><h1 id=cluster-api-vs-cloud-providers>Cluster API vs Cloud Providers <a href=#cluster-api-vs-cloud-providers class=anchor>üîó</a></h1><p>As we have seen, the Cluster API leverages the provider related to the k8s
infrastructure itself (clusters and nodes) and the CCM and the cloud provider
integration for k8s is to leverage the cloud provider to provide support infrastructure.</p><p>Let&rsquo;s say Cluster API is for the k8s administrators and the
CCM is for the k8s users :)</p><h1 id=machine-api>Machine API <a href=#machine-api class=anchor>üîó</a></h1><p>The OpenShift 4 Machine API is a combination of some of the upstream Cluster API
with custom OpenShift resources and it is designed to work in conjunction with
the <a href=https://github.com/openshift/cluster-version-operator target=_blank rel=noopener>Cluster Version Operator</a>.</p><h1 id=openshifts-machine-api-operator>OpenShift&rsquo;s Machine API Operator <a href=#openshifts-machine-api-operator class=anchor>üîó</a></h1><p>The <a href=https://github.com/openshift/machine-api-operator target=_blank rel=noopener>machine-api-operator</a> is
an operator that manages the Machine API objects in an OpenShift 4 cluster.</p><p>The operator is capable of creating machines in AWS and libvirt (more providers
coming soon) via the <a href=https://github.com/openshift/cluster-api/tree/master/pkg/controller/machine target=_blank rel=noopener><code>Machine Controller</code></a> and it is included out of the
box with OCP 4 (and <a href=https://github.com/openshift/machine-api-operator#dev target=_blank rel=noopener>can be deployed in a k8s vanilla as well</a>)</p><h1 id=baremetal>Baremetal <a href=#baremetal class=anchor>üîó</a></h1><p>A baremetal server (or bare-metal) is just a computer server.</p><p>The
last years terms such as virtualization, containers, serverless, etc. have been
popular but at the end of the day, all the code running on top of a SaaS, PaaS
or IaaS is actually running in a real physical server stored in a datacenter
wired to routers, switches and power. That server is a &lsquo;baremetal&rsquo; server.</p><p>If you are used to cloud providers and instances, you probably don&rsquo;t know the
pains of baremetal management&mldr; including things such as connecting to the
virtual console (usually it requires an old java version) to debug issues,
configuring pxe for provisioning baremetal hosts (or attach ISOs via the virtual console&mldr; or insert a CD/DVD physically into the CD carry if you are
&rsquo;lucky&rsquo; enough&mldr;), configuring VLANs for traffic isolation, etc.</p><p>That kind of operations is not &lsquo;cloud&rsquo; ready and there are tools that provide
baremetal management, such as <a href=https://maas.io/ target=_blank rel=noopener>maas</a> or <a href=https://wiki.openstack.org/wiki/Ironic target=_blank rel=noopener>ironic</a>.</p><h1 id=ironic>Ironic <a href=#ironic class=anchor>üîó</a></h1><p>OpenStack bare metal provisioning (or ironic) is an open source project (or even better, a number of open source projects) to manage baremetal hosts. Ironic avoids the administrator to deal with pxe configuration, manual deployments, etc. and provides a defined API and a series of plugins to interact with different baremetal models and vendors.</p><p>Ironic is used in OpenStack to provide <code>baremetal</code> objects but there are some
projects (such as <a href=https://docs.openstack.org/bifrost/latest/ target=_blank rel=noopener>bifrost</a>) to use
Ironic &lsquo;standalone&rsquo; (so, no OpenStack required)</p><h1 id=metal3>Metal3 <a href=#metal3 class=anchor>üîó</a></h1><p><a href=https://metal3.io target=_blank rel=noopener>Metal3</a> is a project aimed at providing a baremetal operator that
implements the Cluster API framework required to be able to manage baremetal
in a k8s way (easy peasy!). It uses <a href=https://github.com/metal3-io/metal3-docs/blob/master/design/use-ironic.md target=_blank rel=noopener>ironic under the hood</a> to avoid reinventing the
wheel, but consider it as an implementation detail that may change.</p><p>The Metal3 baremetal operator watches for <code>BareMetalHost</code> (CRD) objects defined as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>metal3.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>BareMetalHost</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-worker-0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>online</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>bootMACAddress</span>: <span style=color:#ae81ff>00</span>:<span style=color:#ae81ff>11</span>:<span style=color:#ae81ff>22</span>:<span style=color:#ae81ff>33</span>:<span style=color:#ae81ff>44</span>:<span style=color:#ae81ff>55</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>bmc</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>: <span style=color:#ae81ff>ipmi://my-worker-0.ipmi.example.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>credentialsName</span>: <span style=color:#ae81ff>my-worker-0-bmc-secret</span>
</span></span></code></pre></div><p>There are a few more fields in the <a href=https://github.com/metal3-io/baremetal-operator/blob/master/pkg/apis/metal3/v1alpha1/baremetalhost_types.go target=_blank rel=noopener><code>BareMetalHost</code> object</a> such as the image, hardware profile, etc.</p><p>The Metal3 project is actually divided into two different components:</p><h2 id=baremetal-operator>baremetal-operator <a href=#baremetal-operator class=anchor>üîó</a></h2><p>The <a href=https://github.com/metal3-io/baremetal-operator target=_blank rel=noopener>Metal3 baremetal-operator</a> is the component that manages baremetal hosts. It exposes a new <code>BareMetalHost</code> custom resource in the k8s API that lets you manage hosts in a declarative way.</p><h2 id=cluster-api-provider-baremetal>cluster-api-provider-baremetal <a href=#cluster-api-provider-baremetal class=anchor>üîó</a></h2><p>The <a href=https://github.com/metal3-io/cluster-api-provider-baremetal target=_blank rel=noopener>Metal3 cluster-api-provider-baremetal</a> includes the integration with the Cluster API project. This provider currently includes a Machine actuator that acts as a client of the BareMetalHost custom resources.</p><h1 id=baremetalhost-vs-machine-vs-node>BareMetalHost vs Machine vs Node <a href=#baremetalhost-vs-machine-vs-node class=anchor>üîó</a></h1><ul><li><code>BareMetalHost</code> is a Metal3 object</li><li><code>Machine</code> is a Cluster API object</li><li>Node is where the pods run :)</li></ul><p>Those three concepts are linked in a 1:1:1 relationship meaning:</p><p>A <code>BareMetalHost</code> created with Metal3 maps to a <code>Machine</code> object and once the
installation procedure finishes, a new kubernetes node will be added to the
cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span>NAME                                         STATUS   ROLES    AGE   VERSION
</span></span><span style=display:flex><span>my-node-0.example.com                        Ready    master   25h   v1.14.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get machines --all-namespaces
</span></span><span style=display:flex><span>NAMESPACE               NAME                  INSTANCE   STATE   TYPE   REGION   ZONE   AGE
</span></span><span style=display:flex><span>openshift-machine-api   my-node-0                                                   25h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get baremetalhosts --allnamespaces                 
</span></span><span style=display:flex><span>NAMESPACE               NAME            STATUS   PROVISIONING STATUS   MACHINE         BMC                                                      HARDWARE PROFILE   ONLINE   ERROR
</span></span><span style=display:flex><span>openshift-machine-api   my-node-0   OK       provisioned           my-node-0.example.com   ipmi://1.2.3.4   unknown            true     
</span></span></code></pre></div><p>The 1:1 relationship for the <code>BareMetalHost</code> and the <code>Machine</code> is stored in the
<code>machineRef</code> field in the <code>BareMetalHost</code> object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl  get baremetalhost/my-node-0 -n openshift-machine-api -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.spec.machineRef}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>map<span style=color:#f92672>[</span>name:my-node-0 namespace:openshift-machine-api<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>In a <code>Machine</code> annotation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get machines my-node-0 -n openshift-machine-api -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.metadata.annotations}&#39;</span>
</span></span><span style=display:flex><span>map<span style=color:#f92672>[</span>metal3.io/BareMetalHost:openshift-machine-api/my-node-0<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>The 1:1 relationship for the <code>Machine</code> and the <code>Node</code> currently requires to
execute the <a href=https://github.com/openshift-metal3/dev-scripts/blob/master/link-machine-and-node.sh target=_blank rel=noopener>link-machine-and-node.sh</a> script to modify the <code>Machine</code>
object <code>.status</code> field:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./link-machine-and-node.sh MACHINE NODE
</span></span></code></pre></div><p>Then, the reference is stored in the <code>.status.nodeRef.name</code> field in the
<code>Machine</code> object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get machine my-node-0 -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.nodeRef.name}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my-node-0.example.com
</span></span></code></pre></div><h1 id=recap>Recap <a href=#recap class=anchor>üîó</a></h1><p>Being able to &lsquo;just scale a node&rsquo; in k8s means a lot of underlying concepts and technologies involved behind the scenes :)</p><h1 id=resourceslinks>Resources/links <a href=#resourceslinks class=anchor>üîó</a></h1><ul><li><a href=https://dzone.com/articles/introducing-the-kubernetes-cluster-api-project-2 target=_blank rel=noopener>https://dzone.com/articles/introducing-the-kubernetes-cluster-api-project-2</a></li><li><a href=https://blogs.vmware.com/cloudnative/2019/03/14/what-and-why-of-cluster-api/ target=_blank rel=noopener>https://blogs.vmware.com/cloudnative/2019/03/14/what-and-why-of-cluster-api/</a></li><li><a href=https://kubernetes-sigs.github.io/cluster-api/ target=_blank rel=noopener>https://kubernetes-sigs.github.io/cluster-api/</a></li><li><a href=https://github.com/kubernetes-sigs/cluster-api-provider-aws target=_blank rel=noopener>https://github.com/kubernetes-sigs/cluster-api-provider-aws</a></li><li><a href=https://itnext.io/deep-dive-to-cluster-api-a0b4e792d57d target=_blank rel=noopener>https://itnext.io/deep-dive-to-cluster-api-a0b4e792d57d</a></li><li><a href=https://www.linux.com/blog/event/kubecon/2018/4/extending-kubernetes-cluster-api target=_blank rel=noopener>https://www.linux.com/blog/event/kubecon/2018/4/extending-kubernetes-cluster-api</a></li></ul></div><div class=tags><a href=https://www.underkube.com/pr-preview/pr-46/tags/kubernetes>kubernetes</a>
<a href=https://www.underkube.com/pr-preview/pr-46/tags/metal3>metal3</a>
<a href=https://www.underkube.com/pr-preview/pr-46/tags/openshift>openshift</a></div><div id=comment><script src=https://giscus.app/client.js data-repo=underkube/blog data-repo-id="MDEwOlJlcG9zaXRvcnkxOTI1NTk4MzA=" data-category=Q&A data-category-id=DIC_kwDOC3o61s4CAdCk data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=light data-lang=en crossorigin=anonymous async></script></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/e-minguez/underkube target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg>
</a><a class=symbol href=https://www.twitter.com/minwi target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg>
</a><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=minwi data-description="Support me on Buy me a coffee!" data-message=Gracias! data-color=#FFDD00 data-position=Right data-x_margin=18 data-y_margin=18></script><p><a href=https://librecounter.org/referer/show target=_blank><img src=https://librecounter.org/oldStyle.svg referrerpolicy=unsafe-url></a></p></div><div class=copyright>¬© Copyright
2026
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg>
</span>Eduardo M√≠nguez</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-cactus-plus>nodejh</a></div></footer></body></html>